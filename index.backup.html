<!DOCTYPE html>
<html lang="pt-BR">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Vivência Pombogira — Livro Digital</title>
		<meta name="description" content="Os Mistérios de Pombogira: Interior, Emoção e Evolução. Uma obra sobre verdade emocional, libertação interna e cura afetiva na Umbanda Sagrada." />
		<meta name="author" content="Terreiro Tia Maria e Cabocla Jupira" />
		<meta name="color-scheme" content="light dark" />
		
		<!-- Open Graph / Facebook -->
		<meta property="og:type" content="website" />
		<meta property="og:title" content="Vivência Pombogira — Livro Digital" />
		<meta property="og:description" content="Os Mistérios de Pombogira: Interior, Emoção e Evolução. Uma obra sobre verdade emocional, libertação interna e cura afetiva." />
		<meta property="og:locale" content="pt_BR" />
		
		<!-- Twitter -->
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:title" content="Vivência Pombogira — Livro Digital" />
		<meta name="twitter:description" content="Os Mistérios de Pombogira: Interior, Emoção e Evolução. Uma obra sobre verdade emocional, libertação interna e cura afetiva." />
		
		<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%23b10e3c'/%3E%3Cpath d='M32 16c6 6-2 10-2 16s8 8 2 16c-6-6 2-10 2-16s-8-8-2-16z' fill='%23fff' opacity='.5'/%3E%3C/svg%3E" />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Merriweather:wght@400;700&display=swap" rel="stylesheet" />
		<style>
			:root {
				--bg: #faf8fb;
				--fg: #18161a;
				--muted: #5b5561;
				--card: #ffffff;
				--border: #eae4ee;
				--accent: #b10e3c; /* carmim */
				--accent-2: #d9608f; /* rosa queimado */
				--shadow: 0 8px 24px rgba(24, 22, 26, 0.08);
				--maxw: 88ch;
				--content-font: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif;
				--heading-font: 'Merriweather', Georgia, 'Times New Roman', Times, serif;
				--content-size: 1rem;
				--line: 1.8;
				--toc-w: 280px;
				--header-h: 64px;
				--paper-tint: radial-gradient(1200px 600px at 50% -10%, rgba(177,14,60,0.06), transparent 60%),
												radial-gradient(800px 300px at 90% 10%, rgba(217,96,143,0.05), transparent 60%),
												radial-gradient(900px 400px at 10% 0%, rgba(24,22,26,0.03), transparent 60%);
			}
			[data-theme="dark"] {
				--bg: #0f0e11;
				--fg: #f5f1f6;
				--muted: #b9aebf;
				--card: #16141a;
				--border: #28232d;
				--shadow: 0 10px 26px rgba(0, 0, 0, 0.35);
				--accent: #e23a6a;
				--accent-2: #a14a73;
				--paper-tint: radial-gradient(1200px 600px at 50% -10%, rgba(226,58,106,0.06), transparent 60%),
												radial-gradient(800px 300px at 90% 10%, rgba(161,74,115,0.08), transparent 60%);
			}
			[data-theme="sepia"] {
				--bg: #f7efe5;
				--fg: #2b1f1a;
				--muted: #6e5a50;
				--card: #fbf6ef;
				--border: #eadfd5;
				--shadow: 0 8px 24px rgba(63, 45, 35, 0.12);
				--accent: #9f2f41;
				--accent-2: #b86a74;
				--paper-tint: radial-gradient(1200px 600px at 50% -10%, rgba(159,47,65,0.05), transparent 60%),
											 radial-gradient(800px 300px at 90% 10%, rgba(184,106,116,0.06), transparent 60%);
			}
			html, body { height: 100%; }
			body {
				margin: 0;
				background: var(--bg);
				background-image: var(--paper-tint);
				color: var(--fg);
				font-family: var(--content-font);
				font-size: var(--content-size);
				line-height: var(--line);
				-webkit-font-smoothing: antialiased;
				-moz-osx-font-smoothing: grayscale;
			}
			.topbar {
				position: sticky;
				top: 0;
				z-index: 1000;
				height: var(--header-h);
				display: flex;
				align-items: center;
				justify-content: space-between;
				padding: 0 16px;
				background: linear-gradient(180deg, rgba(0,0,0,0.06), transparent), var(--card);
				border-bottom: 1px solid var(--border);
				backdrop-filter: saturate(120%) blur(6px);
			}
			.brand {
				display: flex;
				align-items: baseline;
				gap: 10px;
			}
			.brand h1 {
				margin: 0;
				font: 700 18px var(--heading-font);
				letter-spacing: 0.3px;
			}
			.brand span {
				color: var(--muted);
				font-size: 12px;
				letter-spacing: 0.4px;
				text-transform: uppercase;
			}
			.controls {
				display: flex;
				gap: 8px;
			}
			.btn {
				border: 1px solid var(--border);
				background: var(--card);
				color: var(--fg);
				padding: 8px 10px;
				border-radius: 10px;
				cursor: pointer;
				font: 500 13px var(--content-font);
			}
			.btn:hover { border-color: var(--accent-2); }
			.btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
			.layout {
				display: grid;
				grid-template-columns: minmax(0, 1fr);
				gap: 24px;
			}
			@media (min-width: 1100px) {
				.layout { grid-template-columns: var(--toc-w) minmax(0, 1fr); }
			}
			aside#toc {
				position: sticky;
				top: calc(var(--header-h) + 12px);
				align-self: start;
				padding: 12px 12px 24px;
				margin: 12px;
				background: var(--card);
				border: 1px solid var(--border);
				border-radius: 14px;
				box-shadow: var(--shadow);
				max-height: calc(100dvh - var(--header-h) - 36px);
				overflow: auto;
			}
			#toc h2 { font: 700 14px var(--heading-font); margin: 8px 6px 12px; letter-spacing: .3px; }
			#toc .toc-search { width: 100%; margin: 0 0 10px; }
			#toc .toc-search input {
				width: 100%; padding: 8px 10px; border-radius: 10px; border: 1px solid var(--border);
				background: var(--card); color: var(--fg);
			}
			#toc ul { list-style: none; padding-left: 8px; margin: 0; }
			#toc li { margin: 4px 0; }
			#toc a {
				text-decoration: none;
				color: var(--muted);
				display: block;
				padding: 4px 6px;
				border-radius: 8px;
			}
			#toc a:hover, #toc a.active { color: var(--fg); background: rgba(177,14,60,0.08); }
			#toc a.active { border-left: 3px solid var(--accent); padding-left: 8px; }
			#toc .lvl-1 { font-weight: 600; color: var(--fg); }
			#toc .lvl-2 { padding-left: 10px; }
			#toc .lvl-3 { padding-left: 20px; font-size: 0.92em; }
			#toc .lvl-4 { padding-left: 30px; font-size: 0.9em; }

			main {
				padding: 16px;
				display: flex;
				justify-content: center;
			}
			article#content {
				background: var(--card);
				border: 1px solid var(--border);
				border-radius: 18px;
				box-shadow: var(--shadow);
				padding: 36px 32px 64px;
				max-width: var(--maxw);
				width: 100%;
				text-align: justify;
				hyphens: auto;
			}
			/* Typography */
			article#content h1, h2, h3, h4, h5 { font-family: var(--heading-font); line-height: 1.35; }
			article#content h1 { font-size: 2rem; margin: 0 0 12px; letter-spacing: 0.2px; }
			article#content h2 { font-size: 1.6rem; margin: 36px 0 10px; letter-spacing: 0.15px; }
			article#content h3 { font-size: 1.25rem; margin: 24px 0 8px; }
			article#content h4 { font-size: 1.05rem; margin: 18px 0 6px; color: var(--fg); }
			article#content p { margin: 14px 0; }
			article#content hr { border: none; border-top: 1px solid var(--border); margin: 28px 0; }
			article#content a { color: var(--accent); text-decoration: none; }
			article#content a:hover { text-decoration: underline; }
			article#content blockquote { border-left: 3px solid var(--accent-2); padding: 8px 14px; margin: 14px 0; color: var(--muted); background: rgba(217,96,143,0.07); border-radius: 8px; }
			/* Dropcap for first text after main headings */
			article#content h1 + p::first-letter,
			article#content h2 + p::first-letter { float: left; font-family: var(--heading-font); font-size: 3.2rem; line-height: .9; padding: 6px 8px 0 0; color: var(--accent); }
			article#content h1, article#content h2 {
				position: relative;
				padding-bottom: 6px;
			}
			article#content h1::after, article#content h2::after {
				content: "";
				position: absolute; left: 0; bottom: 0;
				width: 80px; height: 3px;
				background: linear-gradient(90deg, var(--accent), transparent);
				border-radius: 2px;
			}
			/* Chapter ornament and síntese callout */
			article#content h2.chapter { margin-top: 48px; }
			article#content h2.chapter::before {
				content: "◦";
				color: var(--accent);
				font-size: 22px; position: absolute; left: -22px; top: 2px;
			}
			article#content h4.sintese { padding: 4px 10px; background: rgba(177,14,60,0.08); border: 1px solid var(--border); border-radius: 999px; display: inline-block; }

			/* Heading anchor links */
			.anchor-link { opacity: 0; margin-left: 8px; text-decoration: none; font-weight: 600; color: var(--muted); }
			#content h1:hover .anchor-link, #content h2:hover .anchor-link, #content h3:hover .anchor-link, #content h4:hover .anchor-link { opacity: 1; }

			/* Progress bar */
			.progress {
				position: fixed; top: 0; left: 0; height: 3px; width: 100%; background: transparent; z-index: 1200;
			}
			.progress .bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); }

      /* Back to top */
      #backTop {
        position: fixed; right: 12px; bottom: 12px; z-index: 1200;
        border: 1px solid var(--border); background: var(--card); color: var(--fg);
        padding: 12px; border-radius: 50%; cursor: pointer; box-shadow: var(--shadow);
        opacity: 0; transform: translateY(8px); transition: .2s ease opacity, .2s ease transform;
        width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;
      }
      #backTop.show { opacity: 1; transform: translateY(0); }
      @media (min-width: 640px) {
        #backTop { right: 16px; bottom: 16px; }
      }			/* Print */
			@media print {
				.topbar, aside#toc, .progress { display: none !important; }
				article#content { border: none; box-shadow: none; }
				body { background: #fff; color: #000; }
			}
		</style>
	</head>
	<body>
		<div class="progress"><div class="bar" id="progressBar"></div></div>
		<header class="topbar">
			<div class="brand">
				<h1>Vivência Pombogira</h1>
				<span>Livro Digital</span>
			</div>
			<div class="controls">
				<button class="btn" id="themeBtn" aria-label="Alternar tema">Tema</button>
				<button class="btn" id="decFont" aria-label="Diminuir fonte">A−</button>
				<button class="btn" id="incFont" aria-label="Aumentar fonte">A+</button>
				<button class="btn" id="openFile" aria-label="Abrir arquivo Markdown">Abrir arquivo</button>
			</div>
		</header>

		<div class="layout">
			<aside id="toc">
				<h2>Sumário</h2>
				<div class="toc-search"><input id="tocSearch" type="search" placeholder="Filtrar títulos…" aria-label="Filtrar títulos" /></div>
				<ul id="tocList"></ul>
			</aside>
			<main>
				<article id="content" aria-label="Conteúdo do livro">
					<p style="color: var(--muted);">Carregando conteúdo…</p>
				</article>
			</main>
		</div>
		<input type="file" id="filePicker" accept=".md,text/markdown" style="display:none" />
		<button id="backTop" title="Voltar ao topo">Topo</button>

		<!-- Load Marked from CDN (no SRI to avoid mismatch issues); pinned path optional -->
		<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
		<script>
			// State + settings
			const STORAGE_KEYS = { theme: 'book-theme', font: 'book-font-size' };
			const mdPath = 'Source/vivencia_pombogira.md';

			// Theme restore
			const savedTheme = localStorage.getItem(STORAGE_KEYS.theme);
			if (savedTheme === 'dark' || savedTheme === 'sepia') document.documentElement.setAttribute('data-theme', savedTheme);

			// Font size restore
			const savedFont = localStorage.getItem(STORAGE_KEYS.font);
			if (savedFont) document.documentElement.style.setProperty('--content-size', savedFont);

			// Utils
			const slugify = (str) => {
				return str
					.normalize('NFD').replace(/[\u0300-\u036f]/g, '') // remove diacríticos
					.toLowerCase()
					.replace(/[^a-z0-9\s\-_.]/g, '')
					.trim()
					.replace(/\s+/g, '-');
			};

			const buildTOC = () => {
				const container = document.getElementById('tocList');
				container.innerHTML = '';
				const headings = document.querySelectorAll('#content h1, #content h2, #content h3, #content h4');
				let lastLevel = 1; // start
				const stack = [container];

				headings.forEach((h) => {
					const level = parseInt(h.tagName.substring(1), 10);
					// Assign id if missing
					if (!h.id) h.id = slugify(h.textContent);
					const li = document.createElement('li');
					const a = document.createElement('a');
					a.textContent = h.textContent;
					a.href = `#${h.id}`;
					a.className = `lvl-${level - 0}`; // e.g., lvl-2, lvl-3
					li.appendChild(a);

					// Ensure nesting based on level
					let currentList = stack[stack.length - 1];
					const currentLevel = stack.length; // stack base at 1
					const targetLevel = level; // map h1->1, h2->2, ...

					// Adjust stack to target level
					while (stack.length > targetLevel) stack.pop();
					while (stack.length < targetLevel) {
						const newUl = document.createElement('ul');
						stack[stack.length - 1].lastElementChild?.appendChild(newUl);
						stack.push(newUl);
					}
					stack[stack.length - 1].appendChild(li);
				});

				// Active link on scroll
				const links = container.querySelectorAll('a');
				const map = new Map();
				links.forEach((a) => { const el = document.getElementById(a.getAttribute('href').slice(1)); if (el) map.set(el, a); });
				const io = new IntersectionObserver((entries) => {
					entries.forEach((entry) => {
						const link = map.get(entry.target);
						if (!link) return;
						if (entry.isIntersecting) {
							links.forEach((l) => l.classList.remove('active'));
							link.classList.add('active');
							// Keep active link in view inside the TOC panel
							const visible = getComputedStyle(link).display !== 'none';
							if (visible) {
								link.scrollIntoView({ block: 'nearest', inline: 'nearest' });
							}
						}
					});
				}, { rootMargin: '0px 0px -75% 0px', threshold: [0, 1] });
				map.forEach((_, el) => io.observe(el));

				container.addEventListener('click', (e) => {
					const target = e.target.closest('a');
					if (!target) return;
					e.preventDefault();
					const id = target.getAttribute('href').slice(1);
					const el = document.getElementById(id);
					if (el) window.scrollTo({ top: el.getBoundingClientRect().top + window.scrollY - 12, behavior: 'smooth' });
				});

				// TOC filter
				const search = document.getElementById('tocSearch');
				if (search) {
					const allLinks = container.querySelectorAll('a');
					search.addEventListener('input', () => {
						const q = search.value.trim().toLowerCase();
						allLinks.forEach((a) => {
							const match = a.textContent.toLowerCase().includes(q);
							a.style.display = match || !q ? '' : 'none';
						});
					});
				}
			};

			const updateProgress = () => {
				const bar = document.getElementById('progressBar');
				const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
				const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
				const p = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;
				bar.style.width = p + '%';
			};
			document.addEventListener('scroll', () => { updateProgress(); toggleBackTop(); }, { passive: true });

			const toggleBackTop = () => {
				const btn = document.getElementById('backTop');
				const y = window.scrollY || document.documentElement.scrollTop;
				if (y > 600) btn.classList.add('show'); else btn.classList.remove('show');
			};

			// Fallback rendering when Marked is unavailable
			const escapeHtml = (s) => s
				.replace(/&/g, '&amp;')
				.replace(/</g, '&lt;')
				.replace(/>/g, '&gt;');

			const renderMarkdown = (md) => {
				if (window.marked) {
					marked.setOptions({ gfm: true, breaks: false, smartypants: true });
					try { return marked.parse(md); } catch (_) {}
				}
				return `
					<div style="border:1px solid var(--border); border-radius:12px; padding:12px;">
						<p style="color:var(--muted); margin-top:0;">Biblioteca de Markdown não carregada. Exibindo conteúdo simples.</p>
						<pre style="white-space:pre-wrap;">${escapeHtml(md)}</pre>
					</div>`;
			};

			// Load + render Markdown
			const contentEl = document.getElementById('content');
			fetch(mdPath)
				.then((r) => {
					if (!r.ok) throw new Error('Falha ao carregar o manuscrito.');
					return r.text();
				})
				.then((md) => {
					const html = renderMarkdown(md);
					contentEl.innerHTML = html;
					postProcessHeadings();
					// Ensure headings have ids for deep links + TOC
					document.querySelectorAll('#content h1, #content h2, #content h3, #content h4').forEach((h) => {
						if (!h.id) h.id = slugify(h.textContent);
					});
					buildTOC();
					updateProgress();
					// Scroll to hash if present
					if (location.hash) {
						const id = decodeURIComponent(location.hash.slice(1));
						const target = document.getElementById(id);
						if (target) window.scrollTo({ top: target.getBoundingClientRect().top + window.scrollY - 12, behavior: 'instant' });
					}
				})
				.catch((err) => {
					contentEl.innerHTML = `
						<p style=\"color: var(--muted);\">
							Não foi possível carregar o conteúdo automaticamente. 
							Alguns navegadores bloqueiam <code>fetch</code> de arquivos locais quando você abre o <code>index.html</code> diretamente.
						</p>
						<p style=\"color: var(--muted);\">
							Opções:
							<br>1) Clique em <strong>Abrir arquivo</strong> e selecione o <code>Source/vivencia_pombogira.md</code>.
							<br>2) Abra este arquivo via um servidor local (ex.: Live Server / Python http.server).
						</p>`;
					console.error(err);
				});

			// Controls
			// (Removed duplicate 2-state theme toggler; see 3-state cycle at bottom)
			const setFont = (delta) => {
				const style = getComputedStyle(document.documentElement);
				const current = parseFloat(style.getPropertyValue('--content-size')) || 1;
				const next = Math.min(1.4, Math.max(0.9, current + delta));
				document.documentElement.style.setProperty('--content-size', next + 'rem');
				localStorage.setItem(STORAGE_KEYS.font, next + 'rem');
			};
			document.getElementById('incFont').addEventListener('click', () => setFont(0.05));
			document.getElementById('decFont').addEventListener('click', () => setFont(-0.05));

			// File picker fallback
			const fileInput = document.getElementById('filePicker');
			const openBtn = document.getElementById('openFile');
			openBtn.addEventListener('click', () => fileInput.click());
			fileInput.addEventListener('change', (e) => {
				const file = e.target.files?.[0];
				if (!file) return;
				const reader = new FileReader();
				reader.onload = () => {
					const md = String(reader.result || '');
					const html = renderMarkdown(md);
					contentEl.innerHTML = html;
					postProcessHeadings();
					document.querySelectorAll('#content h1, #content h2, #content h3, #content h4').forEach((h) => {
						if (!h.id) h.id = slugify(h.textContent);
					});
					buildTOC();
					updateProgress();
					// Optionally reflect file name in brand subtitle
					const brandSubtitle = document.querySelector('.brand span');
					if (brandSubtitle) brandSubtitle.textContent = file.name;
				};
				reader.readAsText(file, 'utf-8');
			});

			// Add classes for special headings and anchor links
			function postProcessHeadings() {
				document.querySelectorAll('#content h2').forEach((h) => {
					const txt = (h.textContent || '').trim();
					if (/^cap[ií]tulo\b/i.test(txt)) h.classList.add('chapter');
				});
				document.querySelectorAll('#content h4').forEach((h) => {
					const txt = (h.textContent || '').trim();
					if (/^s[ií]ntese/i.test(txt)) h.classList.add('sintese');
				});
				// Anchor links
				document.querySelectorAll('#content h1, #content h2, #content h3, #content h4').forEach((h) => {
					if (!h.id) h.id = slugify(h.textContent);
					if (!h.querySelector('.anchor-link')) {
						const a = document.createElement('a');
						a.href = `#${h.id}`;
						a.className = 'anchor-link';
						a.textContent = '#';
						h.appendChild(a);
					}
				});
			}

      // Back to top action
      document.getElementById('backTop').addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      // Mobile TOC toggle
      const tocEl = document.getElementById('toc');
      const overlayEl = document.getElementById('tocOverlay');
      const menuBtn = document.getElementById('menuToggle');
      
      const openTOC = () => {
        tocEl.classList.add('open');
        overlayEl.classList.add('show');
      };
      const closeTOC = () => {
        tocEl.classList.remove('open');
        overlayEl.classList.remove('show');
      };
      
      if (menuBtn) menuBtn.addEventListener('click', openTOC);
      if (overlayEl) overlayEl.addEventListener('click', closeTOC);
      
      // Close TOC when clicking a link on mobile
      document.getElementById('tocList').addEventListener('click', (e) => {
        if (e.target.closest('a') && window.innerWidth < 1100) {
          setTimeout(closeTOC, 300);
        }
      });			// Theme cycle: light -> dark -> sepia -> light
			document.getElementById('themeBtn').addEventListener('click', () => {
				const current = document.documentElement.getAttribute('data-theme') || 'light';
				const next = current === 'light' ? 'dark' : current === 'dark' ? 'sepia' : 'light';
				if (next === 'light') document.documentElement.removeAttribute('data-theme');
				else document.documentElement.setAttribute('data-theme', next);
				localStorage.setItem(STORAGE_KEYS.theme, next);
			});
		</script>
	</body>
	</html>
