<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Obá: Senhora da Concentração e do Conhecimento — Livro Digital</title>
  <meta name="description" content="Apostila completa sobre Obá, a Senhora da Concentração, da Terra Fértil e do Conhecimento. Fundamentos teológicos, desenvolvimento mediúnico e práticas." />
  <meta name="author" content="Terreiro Tia Maria e Cabocla Jupira" />
  <meta name="color-scheme" content="light dark" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Obá: Senhora da Concentração e do Conhecimento — Livro Digital" />
  <meta property="og:description" content="Apostila completa sobre Obá, a Senhora da Concentração, da Terra Fértil e do Conhecimento." />
  <meta property="og:locale" content="pt_BR" />
  <link rel="canonical" href="/livros/aula_oba" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%236b4423'/%3E%3Cpath d='M32 20v24M20 32h24' stroke='%23fff' stroke-width='3' opacity='.7'/%3E%3C/svg%3E" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Merriweather:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../styles/base.css" />
  <link rel="stylesheet" href="../styles/theme-oba.css" />
  <style>
    /* Hide content until access is validated */
    html { visibility: hidden; opacity: 0; }
  </style>
  <script>
    // CRITICAL: Block rendering until access validated
    // Version: 3 (force cache bust)
    console.log('[ACCESS GUARD] Script loaded - v3');
    (function() {
      'use strict';
      console.log('[ACCESS GUARD] Starting validation...');
      const path = window.location.pathname;
      console.log('[ACCESS GUARD] Path:', path);
      const match = path.match(/\/livros\/(.+?)(?:\.html)?$/);
      if (!match) {
        console.log('[ACCESS GUARD] Not a book page, showing content');
        document.documentElement.style.visibility = 'visible';
        document.documentElement.style.opacity = '1';
        return;
      }
      
      const bookSlug = match[1];
      console.log('[ACCESS GUARD] Book slug:', bookSlug);
      
      fetch('/api/auth/validate?bookSlug=' + encodeURIComponent(bookSlug) + '&_=' + Date.now())
        .then(function(res) {
          console.log('[ACCESS GUARD] Response status:', res.status);
          return res.json().then(function(data) {
            return { ok: res.ok, data: data };
          });
        })
        .then(function(result) {
          console.log('[ACCESS GUARD] Result:', result);
          if (!result.ok || !result.data.valid) {
            console.log('[ACCESS GUARD] ❌ Access DENIED to:', bookSlug);
            alert('Acesso negado. Você será redirecionado.');
            window.location.replace('/auth/no-access.html');
          } else {
            console.log('[ACCESS GUARD] ✅ Access GRANTED to:', bookSlug);
            document.documentElement.style.visibility = 'visible';
            document.documentElement.style.opacity = '1';
          }
        })
        .catch(function(err) {
          console.error('[ACCESS GUARD] Error:', err);
          alert('Erro ao validar acesso: ' + err.message);
          window.location.replace('/auth/no-access.html');
        });
    })();
  </script>
</head>
  <div class="progress"><div class="bar" id="progressBar"></div></div>
  <header class="topbar">
    <div class="brand">
      <h1>Obá: Concentração e Conhecimento</h1>
      <nav aria-label="Breadcrumb"><a href="../index.html">← Biblioteca</a><span class="sep">›</span><span>Livro</span></nav>
    </div>
    <div class="controls">
      <a href="../index.html" class="btn" aria-label="Voltar à biblioteca">← Voltar</a>
      <button class="btn" id="themeBtn" aria-label="Alternar tema">Tema</button>
      <button class="btn" id="decFont" aria-label="Diminuir fonte">A−</button>
      <button class="btn" id="incFont" aria-label="Aumentar fonte">A+</button>
    </div>
  </header>

  <section class="hero-cover" aria-label="Capa">
    <div class="media">
      <img src="../Source/img/Capa_Oba.png" alt="Capa da apostila Obá" loading="lazy" />
      <div class="overlay"></div>
      <div class="text">
        <h1>Obá: Terra Fértil e Foco</h1>
        <p>A Senhora da Concentração, do Conhecimento e da Força Mental.</p>
      </div>
    </div>
  </section>

  <div class="layout">
    <aside id="toc">
      <h2>Sumário</h2>
      <div class="toc-search"><input id="tocSearch" type="search" placeholder="Filtrar tópicos…" aria-label="Filtrar tópicos" /></div>
      <ul id="tocList"></ul>
    </aside>
    <main>
      <article id="content" aria-label="Conteúdo do livro"><p style="color: var(--muted);">Carregando conteúdo…</p></article>
    </main>
  </div>
  <button id="backTop" title="Voltar ao topo">Topo</button>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
  const STORAGE_KEYS = { theme: 'oba-theme', font: 'oba-font-size' };
  const mdPath = '../Source/Aula_oba.md';

  // Restore theme
  const savedTheme = localStorage.getItem(STORAGE_KEYS.theme);
  if (savedTheme === 'dark' || savedTheme === 'sepia') document.documentElement.setAttribute('data-theme', savedTheme);

  // Restore font size
  const savedFont = localStorage.getItem(STORAGE_KEYS.font);
  if (savedFont) document.documentElement.style.setProperty('--content-size', savedFont);

  // Slugify helper
  const slugify = (str) => str.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[^a-z0-9\s\-_.]/g,'').trim().replace(/\s+/g,'-');

  // Fetch + render markdown
  fetch(mdPath).then(r=>r.text()).then(md => {
    const content = document.getElementById('content');
    content.innerHTML = marked.parse(md);
    // Anchor links
    content.querySelectorAll('h1,h2,h3,h4').forEach(h => { if(!h.id) h.id = slugify(h.textContent); const a=document.createElement('a'); a.href='#'+h.id; a.textContent='#'; a.setAttribute('aria-label','Link para '+h.textContent); h.appendChild(a); });
    buildTOC();
  }).catch(err => { document.getElementById('content').innerHTML = `<p style="color: var(--accent);">Erro ao carregar: ${err.message}</p>`; });

  // Build TOC
  function buildTOC(){
    const container = document.getElementById('tocList');
    container.innerHTML='';
    const headings = document.querySelectorAll('#content h1,#content h2,#content h3,#content h4');
    const stack=[container];
    headings.forEach(h=>{ const level=parseInt(h.tagName.substring(1),10); const li=document.createElement('li'); const a=document.createElement('a'); a.textContent=h.textContent; a.href='#'+h.id; a.className='lvl-'+level; li.appendChild(a); while(stack.length>level) stack.pop(); while(stack.length<level){ const ul=document.createElement('ul'); stack[stack.length-1].lastElementChild?.appendChild(ul); stack.push(ul);} stack[stack.length-1].appendChild(li); });
    // Active highlight
    const links = container.querySelectorAll('a');
    const map=new Map(); links.forEach(a=>{ const el=document.getElementById(a.getAttribute('href').slice(1)); if(el) map.set(el,a); });
    const io=new IntersectionObserver(entries=>{ entries.forEach(e=>{ const l=map.get(e.target); if(!l) return; if(e.isIntersecting){ links.forEach(x=>x.classList.remove('active')); l.classList.add('active'); if(getComputedStyle(l).display!=='none') l.scrollIntoView({block:'nearest',inline:'nearest'}); } }); },{rootMargin:'0px 0px -70% 0px'});
    map.forEach((_,el)=>io.observe(el));
  }

  // TOC search
  document.getElementById('tocSearch').addEventListener('input', e=>{
    const q=e.target.value.toLowerCase();
    document.querySelectorAll('#tocList a').forEach(a=>{ a.parentElement.style.display=a.textContent.toLowerCase().includes(q)?'':'none'; });
  });

  // Theme toggle
  document.getElementById('themeBtn').addEventListener('click', ()=>{
    const order=['light','dark','sepia'];
    let current=document.documentElement.getAttribute('data-theme')||'light';
    const next=order[(order.indexOf(current)+1)%order.length];
    document.documentElement.setAttribute('data-theme', next==='light'?'':next);
    localStorage.setItem(STORAGE_KEYS.theme, next);
  });

  // Font size
  document.getElementById('incFont').addEventListener('click',()=>{ const val=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--content-size'))||16; if(val<24){ const nv=val+2; document.documentElement.style.setProperty('--content-size',nv+'px'); localStorage.setItem(STORAGE_KEYS.font,nv+'px'); } });
  document.getElementById('decFont').addEventListener('click',()=>{ const val=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--content-size'))||16; if(val>12){ const nv=val-2; document.documentElement.style.setProperty('--content-size',nv+'px'); localStorage.setItem(STORAGE_KEYS.font,nv+'px'); } });

  // Progress bar
  window.addEventListener('scroll',()=>{ const st=window.pageYOffset||document.documentElement.scrollTop; const sh=document.documentElement.scrollHeight-window.innerHeight; const pct=(st/sh)*100; document.getElementById('progressBar').style.width=pct+'%'; });

  // Back to top
  const back=document.getElementById('backTop');
  window.addEventListener('scroll',()=>{ if(window.scrollY>400){ back.classList.add('show'); } else { back.classList.remove('show'); } });
  back.addEventListener('click',()=>window.scrollTo({top:0,behavior:'smooth'}));
    </script>
    <script src="../scripts/protection.js"></script>
    <script src="../scripts/watermark.js"></script>
</body>
</html>
