<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Guia de Ervas — Leitor de PDF</title>
    <meta name="description" content="Leitor protegido do PDF Guia de Ervas: exibição com marca d'água e travas de cópia." />
    <meta name="author" content="Terreiro Tia Maria e Cabocla Jupira" />
    <meta name="color-scheme" content="light dark" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Guia de Ervas — Livro Digital" />
    <meta property="og:description" content="Guia completo de ervas para Umbanda: usos espirituais, medicinais e classificação energética." />
    <meta property="og:locale" content="pt_BR" />
    <link rel="canonical" href="/livros/guia_de_ervas" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Guia de Ervas — Livro Digital" />
    <meta name="twitter:description" content="Guia completo de ervas para Umbanda: usos espirituais, medicinais e classificação energética." />

    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%23228b22'/%3E%3Cpath d='M32 16l-4 8 4 8 4-8-4-8zm0 16l-8 4 8 4 8-4-8-4z' fill='%23fff' opacity='.6'/%3E%3C/svg%3E" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Merriweather:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="../styles/base.css" />
    <link rel="stylesheet" href="../styles/theme-ervas.css" />
    <style>
      :root {
        --drive-toolbar-height: 56px;
      }
      html { visibility: hidden; opacity: 0; }
      body { margin: 0; min-height: 100vh; background: var(--surface, #f5f5f5); overflow: hidden; }
      .viewer-shell { position: relative; width: 100%; height: calc(100vh - var(--topbar-height, 80px)); background: var(--surface-2, #fff); overflow: auto; -webkit-overflow-scrolling: touch; }
      .viewer-frame { width: 100%; height: 100%; border: 0; display: block; min-height: 100%; }
      .toolbar-blocker { position: fixed; top: var(--topbar-height, 80px); left: 0; width: 100%; height: var(--drive-toolbar-height); pointer-events: auto; z-index: 4; background: linear-gradient(180deg, rgba(0,0,0,0.12), rgba(0,0,0,0.08)); }
      .pdf-loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; }
      .pdf-loading-content { text-align: center; color: #fff; }
      .pdf-loading-spinner { width: 50px; height: 50px; border: 4px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .pdf-loading.hidden { display: none; }
      .pdf-error { position: absolute; inset: 0; display: none; align-items: center; justify-content: center; text-align: center; padding: 1.5rem; background: linear-gradient(180deg, rgba(0,0,0,0.04), rgba(0,0,0,0.08)); z-index: 5; }
      .pdf-error.visible { display: flex; }
      .pdf-error p { margin: 0.5rem 0 0; color: var(--muted, #555); }
    </style>
    <script>
      (function() {
        'use strict';
        const path = window.location.pathname;
        const match = path.match(/\/livros\/(.+?)(?:\.html)?$/);
        if (!match) {
          document.documentElement.style.visibility = 'visible';
          document.documentElement.style.opacity = '1';
          return;
        }
        const bookSlug = match[1];
        fetch('/api/auth/validate?bookSlug=' + encodeURIComponent(bookSlug))
          .then(function(res) {
            return res.json().then(function(data) { return { ok: res.ok, data: data }; });
          })
          .then(function(result) {
            if (!result.ok || !result.data.valid) {
              window.location.replace('/auth/no-access.html');
            } else {
              document.documentElement.style.visibility = 'visible';
              document.documentElement.style.opacity = '1';
            }
          })
          .catch(function() {
            window.location.replace('/auth/no-access.html');
          });
      })();
    </script>
  </head>
  <body>
    <div class="pdf-loading" id="pdfLoading">
      <div class="pdf-loading-content">
        <div class="pdf-loading-spinner"></div>
        <p>Carregando PDF...</p>
      </div>
    </div>
    <div class="progress"><div class="bar" id="progressBar"></div></div>
    <header class="topbar">
      <div class="brand">
        <img src="../Source/img/Logo_Terreiro_Black.png" alt="Logo do Terreiro" class="logo black" />
        <img src="../Source/img/Logo_Terreiro_White.png" alt="Logo do Terreiro" class="logo white" />
        <h1>Guia de Ervas</h1>
        <nav aria-label="Breadcrumb"><a href="../index.html">← Biblioteca</a> <span class="sep">›</span> <span>PDF</span></nav>
      </div>
      <div class="controls">
        <a href="../index.html" class="btn" aria-label="Voltar à biblioteca">← Voltar</a>
        <button class="icon-btn" id="themeToggle" aria-label="Alternar tema" title="Alternar tema">◐</button>
      </div>
    </header>

    <main>
      <article id="content" aria-label="Conteúdo do livro">
        <div class="viewer-shell no-select" id="pdfContainer">
          <div class="toolbar-blocker" aria-hidden="true"></div>
          <iframe id="pdfViewer" class="viewer-frame" title="Leitor de PDF" src="" allow="fullscreen"></iframe>
          <div class="pdf-error" id="pdfError" role="status" aria-live="polite">
            <div>
              <strong>Não foi possível carregar o PDF agora.</strong>
              <p>Verifique sua conexão ou tente novamente em instantes.</p>
            </div>
          </div>
        </div>
      </article>
    </main>

    <script>
      // Config
      const pdfPreviewUrl = 'https://docs.google.com/document/d/1p8DUmneZsEUHYCsgkrb8sC7khWwjOY4zEivqLF44TYc/preview';
      const themes = ['light', 'dark', 'sepia'];

      // Elements
      const pdfViewer = document.getElementById('pdfViewer');
      const pdfContainer = document.getElementById('pdfContainer');
      const pdfLoading = document.getElementById('pdfLoading');
      const pdfError = document.getElementById('pdfError');
      const themeToggle = document.getElementById('themeToggle');
      const headerEl = document.querySelector('.topbar');

      // Theme
      let currentThemeIndex = parseInt(localStorage.getItem('theme-index') || '0', 10);
      const applyTheme = () => {
        document.documentElement.setAttribute('data-theme', themes[currentThemeIndex] || 'light');
        localStorage.setItem('theme-index', currentThemeIndex);
      };
      themeToggle.addEventListener('click', () => {
        currentThemeIndex = (currentThemeIndex + 1) % themes.length;
        applyTheme();
      });
      applyTheme();

      // Layout sizing
      const resizeViewer = () => {
        const h = headerEl?.offsetHeight || 0;
        document.documentElement.style.setProperty('--topbar-height', h + 'px');
        const vh = window.innerHeight || document.documentElement.clientHeight || 800;
        pdfContainer.style.height = Math.max(0, vh - h) + 'px';
      };
      window.addEventListener('resize', resizeViewer);
      window.addEventListener('orientationchange', resizeViewer);
      resizeViewer();

      // Load & fallback handling
      const startAt = performance.now();
      const failWithMessage = () => {
        pdfLoading.classList.add('hidden');
        pdfError.classList.add('visible');
      };

      const loadTimeout = setTimeout(() => {
        failWithMessage();
      }, 8000);

      pdfViewer.addEventListener('load', () => {
        clearTimeout(loadTimeout);
        pdfLoading.classList.add('hidden');
        pdfError.classList.remove('visible');
        const elapsed = performance.now() - startAt;
        window.__pdfLoadMs = elapsed;
        console.info('[PDF] Drive preview carregado em', Math.round(elapsed), 'ms');
      });

      pdfViewer.addEventListener('error', () => {
        clearTimeout(loadTimeout);
        failWithMessage();
      });

      // Kick off
      pdfViewer.src = pdfPreviewUrl;
    </script>
    <script src="../scripts/protection.js"></script>
    <script src="../scripts/watermark.js"></script>
  </body>
</html>
