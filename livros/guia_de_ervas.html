<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Guia de Ervas — Leitor de PDF</title>
    <meta name="description" content="Leitor protegido do PDF Guia de Ervas: exibição com marca d'água e travas de cópia, com controles de zoom." />
    <meta name="author" content="Terreiro Tia Maria e Cabocla Jupira" />
    <meta name="color-scheme" content="light dark" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Guia de Ervas — Livro Digital" />
    <meta property="og:description" content="Guia completo de ervas para Umbanda: usos espirituais, medicinais e classificação energética." />
    <meta property="og:locale" content="pt_BR" />
    <link rel="canonical" href="/livros/guia_de_ervas" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Guia de Ervas — Livro Digital" />
    <meta name="twitter:description" content="Guia completo de ervas para Umbanda: usos espirituais, medicinais e classificação energética." />

    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%23228b22'/%3E%3Cpath d='M32 16l-4 8 4 8 4-8-4-8zm0 16l-8 4 8 4 8-4-8-4z' fill='%23fff' opacity='.6'/%3E%3C/svg%3E" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Merriweather:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="../styles/base.css" />
    <link rel="stylesheet" href="../styles/theme-ervas.css" />
    <style>
      html { visibility: hidden; opacity: 0; overflow: hidden; }
      body { overflow: hidden; height: 100vh; margin: 0; }
      .pdf-container { position: relative; width: 100%; height: calc(100vh - var(--topbar-height, 80px)); overflow: auto; display: block; }
      .pdf-wrapper { transform-origin: top left; display: inline-block; min-width: 100%; min-height: 100%; }
      .toolbar { display: flex; gap: 8px; align-items: center; }
      .toolbar .zoom-display { color: var(--muted); font-size: 0.9rem; }
      .no-select { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
      .pdf-loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; }
      .pdf-loading-content { text-align: center; color: #fff; }
      .pdf-loading-spinner { width: 50px; height: 50px; border: 4px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .pdf-loading.hidden { display: none; }
    </style>
    <script>
      (function() {
        'use strict';
        const path = window.location.pathname;
        const match = path.match(/\/livros\/(.+?)(?:\.html)?$/);
        if (!match) {
          document.documentElement.style.visibility = 'visible';
          document.documentElement.style.opacity = '1';
          return;
        }
        const bookSlug = match[1];
        fetch('/api/auth/validate?bookSlug=' + encodeURIComponent(bookSlug))
          .then(function(res) {
            console.log('[ACCESS GUARD] Response status:', res.status);
            return res.json().then(function(data) { return { ok: res.ok, data: data }; });
          })
          .then(function(result) {
            if (!result.ok || !result.data.valid) {
              console.log('[ACCESS GUARD] ❌ Access DENIED to:', bookSlug);
              window.location.replace('/auth/no-access.html');
            } else {
              console.log('[ACCESS GUARD] ✅ Access GRANTED to:', bookSlug);
              document.documentElement.style.visibility = 'visible';
              document.documentElement.style.opacity = '1';
            }
          })
          .catch(function(err) {
            console.error('[ACCESS GUARD] Error:', err);
            window.location.replace('/auth/no-access.html');
          });
      })();
    </script>
  </head>
    <div class="pdf-loading" id="pdfLoading">
      <div class="pdf-loading-content">
        <div class="pdf-loading-spinner"></div>
        <p>Carregando PDF...</p>
      </div>
    </div>
    <div class="progress"><div class="bar" id="progressBar"></div></div>
    <header class="topbar">
      <div class="brand">
        <img src="../Source/img/Logo_Terreiro_Black.png" alt="Logo do Terreiro" class="logo black" />
        <img src="../Source/img/Logo_Terreiro_White.png" alt="Logo do Terreiro" class="logo white" />
        <h1>Guia de Ervas</h1>
        <nav aria-label="Breadcrumb"><a href="../index.html">← Biblioteca</a> <span class="sep">›</span> <span>PDF</span></nav>
      </div>
      <div class="controls">
        <a href="../index.html" class="btn" aria-label="Voltar à biblioteca">← Voltar</a>
        <div class="toolbar" role="group" aria-label="Controles de zoom">
          <button class="icon-btn" id="zoomOut" aria-label="Diminuir zoom" title="Diminuir zoom">−</button>
          <button class="icon-btn" id="zoomIn" aria-label="Aumentar zoom" title="Aumentar zoom">+</button>
          <span class="zoom-display" id="zoomDisplay" aria-live="polite">100%</span>
        </div>
        <button class="icon-btn" id="themeToggle" aria-label="Alternar tema" title="Alternar tema">◐</button>
      </div>
    </header>

    <main>
      <article id="content" aria-label="Conteúdo do livro">
        <div class="pdf-container no-select" id="pdfContainer">
          <div class="pdf-wrapper" id="pdfWrapper">
            <iframe id="pdfViewer" title="Leitor de PDF" style="border:none; width:100%; height:100%;" src=""></iframe>
          </div>
        </div>
      </article>
    </main>
    <button class="back-to-top" id="backToTop" aria-label="Voltar ao topo">↑</button>

    <script>
      const pdfPath = '../Source/PDF/Guia%20de%20Ervas%20-%20Terreiro%20Tia%20Maria%20e%20Cabocla%20Jupira.pdf';

      // Theme Management (padrão Oyá Logunã)
      const themeToggle = document.getElementById('themeToggle');
      const themes = ['light', 'dark', 'sepia'];
      let currentThemeIndex = parseInt(localStorage.getItem('theme-index') || '0');
      function applyTheme() { document.documentElement.setAttribute('data-theme', themes[currentThemeIndex] || 'light'); localStorage.setItem('theme-index', currentThemeIndex); }
      themeToggle.addEventListener('click', () => { currentThemeIndex = (currentThemeIndex + 1) % themes.length; applyTheme(); });
      applyTheme();

      // Ajusta altura do leitor para ocupar a tela inteira abaixo do header
      const headerEl = document.querySelector('.topbar');
      const pdfContainer = document.getElementById('pdfContainer');
      function resizePdfContainer() {
        const h = (headerEl?.offsetHeight || 0);
        document.documentElement.style.setProperty('--topbar-height', h + 'px');
        const vh = window.innerHeight || document.documentElement.clientHeight || 800;
        pdfContainer.style.height = Math.max(0, vh - h) + 'px';
      }
      window.addEventListener('resize', resizePdfContainer);
      window.addEventListener('orientationchange', resizePdfContainer);

      // PDF Load + Zoom controls
      const pdfViewer = document.getElementById('pdfViewer');
      const pdfWrapper = document.getElementById('pdfWrapper');
      const zoomInBtn = document.getElementById('zoomIn');
      const zoomOutBtn = document.getElementById('zoomOut');
      const zoomDisplay = document.getElementById('zoomDisplay');
      let zoom = parseFloat(localStorage.getItem('pdf-zoom') || '1.0');
      const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
      
      // Carrega o PDF uma única vez sem zoom parameters
      pdfViewer.src = pdfPath + '#toolbar=0&navpanes=0&scrollbar=0&view=FitH';
      
      const applyZoom = () => {
        // Aplica scale no wrapper
        pdfWrapper.style.transform = 'scale(' + zoom + ')';
        
        // Calcula dimensões reais do container
        const containerHeight = pdfContainer.clientHeight;
        const containerWidth = pdfContainer.clientWidth;
        
        // Define largura e altura do wrapper para ocupar o espaço escalado
        pdfWrapper.style.width = containerWidth + 'px';
        pdfWrapper.style.height = (containerHeight * zoom) + 'px';
        
        zoomDisplay.textContent = Math.round(zoom * 100) + '%';
        localStorage.setItem('pdf-zoom', String(zoom));
      };
      
      zoomInBtn.addEventListener('click', () => { 
        zoom = clamp(zoom + 0.1, 0.5, 2.5); 
        applyZoom(); 
      });
      zoomOutBtn.addEventListener('click', () => { 
        zoom = clamp(zoom - 0.1, 0.5, 2.5); 
        applyZoom(); 
      });
      
      // Aguarda o PDF carregar e ser renderizado antes de remover loading
      const pdfLoading = document.getElementById('pdfLoading');
      let loadTimeout;
      
      pdfViewer.addEventListener('load', () => {
        // Aguarda um tempo maior para garantir que o PDF foi renderizado
        loadTimeout = setTimeout(() => {
          applyZoom();
          pdfLoading.classList.add('hidden');
        }, 1500);
      });
      
      // Fallback: remove loading após 10 segundos mesmo se não carregar
      setTimeout(() => {
        pdfLoading.classList.add('hidden');
      }, 10000);
      
      resizePdfContainer();
      applyZoom();

      const slugify = (str) => str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().replace(/[^a-z0-9\s\-_.]/g, '').trim().replace(/\s+/g, '-');

      // Removido: TOC/ancoragem para PDF

      const updateProgress = () => {
        const bar = document.getElementById('progressBar');
        const scrollTop = pdfContainer.scrollTop;
        const scrollHeight = pdfContainer.scrollHeight - pdfContainer.clientHeight;
        const p = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;
        bar.style.width = p + '%';
      };
      pdfContainer.addEventListener('scroll', () => { updateProgress(); toggleBackTop(); }, { passive: true });

      const toggleBackTop = () => {
        const btn = document.getElementById('backToTop');
        const y = pdfContainer.scrollTop;
        if (y > 600) btn.classList.add('visible'); else btn.classList.remove('visible');
      };

      // Conteúdo PDF já carregado via iframe acima

      const setFont = (delta) => {
        const style = getComputedStyle(document.documentElement);
        const current = parseFloat(style.getPropertyValue('--content-size')) || 1;
        const next = Math.min(1.4, Math.max(0.9, current + delta));
        document.documentElement.style.setProperty('--content-size', next + 'rem');
        localStorage.setItem(STORAGE_KEYS.font, next + 'rem');
      };
      document.getElementById('incFont').addEventListener('click', () => setFont(0.05));
      document.getElementById('decFont').addEventListener('click', () => setFont(-0.05));

      // Removido pós-processamento de headings para PDF

      document.getElementById('backToTop').addEventListener('click', () => { pdfContainer.scrollTo({ top: 0, behavior: 'smooth' }); });

      // Sem TOC para PDF

      // (Tema já alternado via themeToggle)
    </script>
    <script src="../scripts/protection.js"></script>
    <script src="../scripts/watermark.js"></script>
  </body>
</html>
