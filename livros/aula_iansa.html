<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Iansã: A Mãe da Lei e do Movimento — Livro Digital</title>
    <meta name="description" content="Apostila completa sobre Iansã, a Mãe da Lei e do Movimento. Fundamentos teológicos, ritualística e práticas na Umbanda Sagrada." />
    <meta name="author" content="Terreiro Tia Maria e Cabocla Jupira" />
    <meta name="color-scheme" content="light dark" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Iansã: A Mãe da Lei e do Movimento — Livro Digital" />
    <meta property="og:description" content="Apostila completa sobre Iansã, a Mãe da Lei e do Movimento. Fundamentos teológicos, ritualística e práticas na Umbanda Sagrada." />
    <meta property="og:locale" content="pt_BR" />
    <link rel="canonical" href="/livros/aula_iansa" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Iansã: A Mãe da Lei e do Movimento — Livro Digital" />
    <meta name="twitter:description" content="Apostila completa sobre Iansã, a Mãe da Lei e do Movimento. Fundamentos teológicos, ritualística e práticas na Umbanda Sagrada." />

    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%23c77a00'/%3E%3Cpath d='M32 16c6 6-2 10-2 16s8 8 2 16c-6-6 2-10 2-16s-8-8-2-16z' fill='%23fff' opacity='.5'/%3E%3C/svg%3E" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Merriweather:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="../styles/base.css" />
    <link rel="stylesheet" href="../styles/theme-iansa.css" />
  </head>
  <body>
    <script>
      (async function() {
        const path = window.location.pathname;
        const match = path.match(/\/livros\/(.+?)\.html$/);
        if (!match) return;
        const bookSlug = match[1];
        try {
          const res = await fetch(`/api/auth/validate?bookSlug=${encodeURIComponent(bookSlug)}`);
          const data = await res.json();
          if (!res.ok || !data.valid) {
            console.log(`[ACCESS GUARD] Access denied to: ${bookSlug}`);
            document.documentElement.style.display = 'none';
            window.location.replace('/auth/no-access.html');
            throw new Error('Access denied');
          }
          console.log(`[ACCESS GUARD] Access granted to: ${bookSlug}`);
        } catch (err) {
          console.error('[ACCESS GUARD] Error:', err);
          document.documentElement.style.display = 'none';
          window.location.replace('/auth/no-access.html');
          throw err;
        }
      })();
    </script>
    <div class="progress"><div class="bar" id="progressBar"></div></div>
    <header class="topbar">
      <div class="brand">
        <h1>Aula Iansã</h1>
        <nav aria-label="Breadcrumb"><a href="../index.html">← Biblioteca</a> <span class="sep">›</span> <span>Livro</span></nav>
      </div>
      <div class="controls">
        <a href="../index.html" class="btn" aria-label="Voltar à biblioteca">← Voltar</a>
        <button class="btn" id="themeBtn" aria-label="Alternar tema">Tema</button>
        <button class="btn" id="decFont" aria-label="Diminuir fonte">A−</button>
        <button class="btn" id="incFont" aria-label="Aumentar fonte">A+</button>
      </div>
    </header>

    <section class="hero-cover" aria-label="Capa">
      <div class="media">
        <img src="../Source/img/Iansa.png" alt="Capa da apostila Iansã: Lei e Movimento" loading="lazy" />
        <div class="overlay"></div>
        <div class="text">
          <h1>Iansã: Lei e Movimento</h1>
          <p>Fundamentos teológicos, ritualística e práticas.</p>
        </div>
      </div>
    </section>

    <div class="layout">
      <aside id="toc">
        <h2>Sumário</h2>
        <div class="toc-search"><input id="tocSearch" type="search" placeholder="Filtrar tópicos…" aria-label="Filtrar tópicos" /></div>
        <ul id="tocList"></ul>
      </aside>
      <main>
        <article id="content" aria-label="Conteúdo do livro">
          <p style="color: var(--muted);">Carregando conteúdo…</p>
        </article>
      </main>
    </div>
    <button id="backTop" title="Voltar ao topo">Topo</button>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
      const STORAGE_KEYS = { theme: 'book-theme', font: 'book-font-size' };
      const mdPath = '../Source/Aula_iansa.md';

      const savedTheme = localStorage.getItem(STORAGE_KEYS.theme);
      if (savedTheme === 'dark' || savedTheme === 'sepia') document.documentElement.setAttribute('data-theme', savedTheme);

      const savedFont = localStorage.getItem(STORAGE_KEYS.font);
      if (savedFont) document.documentElement.style.setProperty('--content-size', savedFont);

      const slugify = (str) => str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().replace(/[^a-z0-9\s\-_.]/g, '').trim().replace(/\s+/g, '-');

      const buildTOC = () => {
        const container = document.getElementById('tocList');
        container.innerHTML = '';
        const headings = document.querySelectorAll('#content h1, #content h2, #content h3, #content h4');
        const stack = [container];
        headings.forEach((h) => {
          const level = parseInt(h.tagName.substring(1), 10);
          if (!h.id) h.id = slugify(h.textContent);
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.textContent = h.textContent; a.href = `#${h.id}`; a.className = `lvl-${level}`; li.appendChild(a);
          while (stack.length > level) stack.pop();
          while (stack.length < level) {
            const newUl = document.createElement('ul');
            stack[stack.length - 1].lastElementChild?.appendChild(newUl);
            stack.push(newUl);
          }
          stack[stack.length - 1].appendChild(li);
        });
        const links = container.querySelectorAll('a');
        const map = new Map();
        links.forEach((a) => { const el = document.getElementById(a.getAttribute('href').slice(1)); if (el) map.set(el, a); });
        const io = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            const link = map.get(entry.target);
            if (!link) return;
            if (entry.isIntersecting) {
              links.forEach((l) => l.classList.remove('active'));
              link.classList.add('active');
              if (getComputedStyle(link).display !== 'none') link.scrollIntoView({ block: 'nearest', inline: 'nearest' });
            }
          });
        }, { rootMargin: '0px 0px -75% 0px', threshold: [0, 1] });
        map.forEach((_, el) => io.observe(el));

        const search = document.getElementById('tocSearch');
        if (search) {
          const allLinks = container.querySelectorAll('a');
          search.addEventListener('input', () => {
            const q = search.value.trim().toLowerCase();
            allLinks.forEach((a) => { const match = a.textContent.toLowerCase().includes(q); a.style.display = match || !q ? '' : 'none'; });
          });
        }
      };

      const updateProgress = () => {
        const bar = document.getElementById('progressBar');
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        const p = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;
        bar.style.width = p + '%';
      };
      document.addEventListener('scroll', () => { updateProgress(); toggleBackTop(); }, { passive: true });

      const toggleBackTop = () => {
        const btn = document.getElementById('backTop');
        const y = window.scrollY || document.documentElement.scrollTop;
        if (y > 600) btn.classList.add('show'); else btn.classList.remove('show');
      };

      const escapeHtml = (s) => s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

      const renderMarkdown = (md) => {
        if (window.marked) {
          marked.setOptions({ gfm: true, breaks: false, smartypants: true });
          try { return marked.parse(md); } catch (_) {}
        }
        return `\n<div style="border:1px solid var(--border); border-radius:12px; padding:12px;">\n  <p style="color:var(--muted); margin-top:0;">Biblioteca de Markdown não carregada. Exibindo conteúdo simples.</p>\n  <pre style="white-space:pre-wrap;">${escapeHtml(md)}</pre>\n</div>`;
      };

      const contentEl = document.getElementById('content');
      fetch(mdPath)
        .then((r) => { if (!r.ok) throw new Error('Falha ao carregar o manuscrito.'); return r.text(); })
        .then((md) => {
          const html = renderMarkdown(md);
          contentEl.innerHTML = html;
          postProcessHeadings();
          document.querySelectorAll('#content h1, #content h2, #content h3, #content h4').forEach((h) => { if (!h.id) h.id = slugify(h.textContent); });
          buildTOC();
          updateProgress();
        })
        .catch((err) => {
          contentEl.innerHTML = `<p style="color:var(--accent); font-weight:600;">Erro ao carregar o livro.</p><p>${err.message}</p>`;
        });

      const postProcessHeadings = () => {
        // Add drop caps to first paragraph after H1/H2
        // Add decorators to chapters
        const h2s = document.querySelectorAll('#content h2');
        h2s.forEach(h2 => {
          if (h2.textContent.toUpperCase().includes('PARTE') || h2.textContent.toUpperCase().includes('CAPÍTULO')) {
            h2.classList.add('chapter');
          }
        });
      };
    </script>
    <script src="../scripts/protection.js"></script>
    <script src="../scripts/watermark.js"></script>
  </body>
</html>