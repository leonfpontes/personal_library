# Implementation Plan: Admin & Watermark Improvements

**Branch**: `2-admin-watermark-improvements` | **Date**: 2025-11-26 | **Spec**: [spec.md](./spec.md)

**Note**: This plan was generated by the `/speckit.plan` command.

## Summary

Implementar duas melhorias no sistema de autenticação:

1. **Admin Role Management**: Adicionar checkbox "Admin" no formulário de cadastro (`auth/admin.html`) com validação de CPF (11 dígitos), permitindo criar usuários com `status='admin'` (acesso total, bypass de grants).
2. **Adaptive Watermark Contrast**: Ajustar `scripts/watermark.js` para detectar tema via `data-theme` e aplicar cores antagonistas (preto em light, branco em dark, marrom em sepia) com opacidade aumentada (0.12 no dark vs 0.08 no light).

## Technical Context

**Language/Version**: JavaScript ES6+ (client), Node.js 18+ (Vercel Edge Functions)

**Primary Dependencies**:

- Frontend: HTML5, CSS3, JavaScript vanilla (sem frameworks)
- Backend: Vercel Edge Runtime, @neondatabase/serverless, bcryptjs, uuid
- Existing: `scripts/admin.js`, `scripts/watermark.js`, `auth/admin.html`

**Storage**: Neon PostgreSQL (sa-east-1) - table `users` com coluna `status` VARCHAR

**Testing**: Manual browser testing (DevTools), visual testing para contraste

**Target Platform**: Web (Chrome 90+, Firefox 88+, Safari 14+, Edge 90+)

**Project Type**: Web application (static + serverless APIs)

**Performance Goals**:

- CPF validation: <50ms frontend (regex-only)
- Watermark theme update: ≤500ms após mudança
- Form submission: <200ms (backend included)

**Constraints**:

- Sem build/transpilação (ES6+ nativo)
- Compatibilidade Vercel (zero-config)
- Opacidade watermark: 0.08-0.12 max
- pt-BR only

**Scale/Scope**:

- 5-10 admin users típicos
- 3 temas (light/dark/sepia)
- 5 livros protegidos

## Constitution Check

*GATE: Must pass before Phase 0. Re-check after Phase 1.*

**Status**: ✅ **PASS** - Aligns with Constitution v1.1.0

### Evaluation

| Gate | Status | Rationale |
|------|--------|-----------|
| Content-first (no build) | ✅ PASS | ES6+ vanilla, sem transpilação. Vercel deploy direto. |
| Editorial integrity (pt-BR) | ✅ PASS | Não afeta manuscritos. Mensagens em pt-BR. |
| File placement | ✅ PASS | Modifica apenas: `auth/admin.html`, `scripts/*.js`, `api/users/*.js`. |
| Naming conventions | ✅ PASS | Sem novos arquivos. |
| Reader template fidelity | ✅ PASS | Watermark script já carregado. Sem mudanças template. |
| mdPath correctness | ✅ PASS | Sem mudanças mdPath. |
| Theme/colors | ✅ PASS | Watermark adapta dinamicamente (sem CSS changes). |
| Catalog card | ✅ PASS | Sem novos livros. |
| Relative paths | ✅ PASS | Paths relativos mantidos. |
| Rights/LGPD | ✅ PASS | Admin role respeita LGPD audit. CPF validation adiciona segurança. |
| **Serverless Exception** | ✅ PASS | Mudanças sob escopo autenticação (Amendment 1.1.0). |

### Post-Design Re-Evaluation

*(Atualizado após Phase 1)*

**Result**: ✅ PASS (sem breaking changes)

## Project Structure

### Documentation

```text
specs/002-admin-watermark-improvements/
├── spec.md              # Feature spec (✅ complete)
├── plan.md              # Este arquivo (✅ complete)
├── research.md          # Phase 0 (✅ skipped - decisões claras)
├── data-model.md        # Phase 1 (✅ complete)
├── quickstart.md        # Phase 1 (✅ complete)
├── contracts/           # Phase 1 (✅ complete)
│   └── admin-api.yaml
└── checklists/
    └── requirements.md  # (✅ complete)
```

### Source Code

```text
personal_library/
├── auth/
│   └── admin.html                    # [MODIFY] Admin checkbox + CPF validation
├── scripts/
│   ├── admin.js                      # [MODIFY] isAdmin field handling
│   └── watermark.js                  # [MODIFY] Theme-aware colors
├── api/
│   ├── users/
│   │   └── index.js                  # [MODIFY] Accept isAdmin, set status
│   └── helpers/
│       └── auth.js                   # [REVIEW] isAdmin() function
└── livros/
    ├── vivencia_pombogira.html       # [TEST] Dark theme watermark
    ├── guia_de_ervas.html            # [TEST] Sepia theme watermark
    ├── aula_iansa.html               # [TEST] Theme adaptation
    ├── aula_oba.html                 # [TEST] Theme adaptation
    └── aula_oya_loguna.html          # [TEST] Theme adaptation
```

**Structure Decision**: Single web app. Incremental changes apenas. Pattern: UI em `auth/`, scripts em `scripts/`, APIs em `api/`.

## Complexity Tracking

**Status**: N/A - Sem violações constitucionais.

---

## Phase 0: Research

**Status**: ✅ **SKIPPED** - Todas decisões técnicas claras no codebase existente.

### Decisions Made

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Admin identification | `users.status` VARCHAR: 'admin', 'active', 'inactive' | Coluna já existe. Sem migration. |
| CPF validation | Frontend regex (11 dígitos) | Spec exclui dígitos verificadores. Backend já valida. |
| Theme detection | `document.documentElement.dataset.theme` | Todos readers já implementam. |
| Watermark colors | Static map: light/dark/sepia → RGBA | Spec fornece valores exatos. |
| Theme change detection | MutationObserver em `<html>` | Mais robusto que EventListener. |

### Alternatives Rejected

| Alternative | Why Rejected |
|-------------|--------------|
| Migration `is_admin` column | `users.status` já existe. |
| Full CPF validation (dígitos) | Nice-to-have, não bloqueante (spec). |
| CSS variable theme detection | `data-theme` mais confiável. |
| EventListener toggle button | MutationObserver captura todas mudanças. |

---

## Phase 1: Design & Contracts

### Data Model

**Entity**: users (existing table, NO CHANGES REQUIRED)

| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| id | VARCHAR(36) | PK | UUID v4 |
| nome | VARCHAR(255) | NOT NULL | |
| cpf | VARCHAR(11) | NOT NULL, UNIQUE | Unmasked |
| cpfMasked | VARCHAR(14) | NOT NULL | `123***789-01` |
| email | VARCHAR(255) | NOT NULL, UNIQUE | |
| password | VARCHAR(255) | NOT NULL | bcrypt |
| **status** | **VARCHAR(20)** | **NOT NULL, DEFAULT 'active'** | **'admin' \| 'active' \| 'inactive'** |
| createdAt | TIMESTAMP | DEFAULT NOW() | |

**Business Rules**:

- `status='admin'`: Bypass grants, acesso `/auth/admin.html`, todos livros
- `status='active'`: Requer grants por livro
- `status='inactive'`: Cannot login
- CPF: exactly 11 numeric digits após remover pontuação

### API Contracts

#### POST /api/users (updated)

**Request**:

```json
{
  "nome": "string (required, 1-255 chars)",
  "cpf": "string (required, 11 numeric digits)",
  "email": "string (required, valid email)",
  "password": "string (required, min 6 chars)",
  "isAdmin": "boolean (optional, default: false)"
}
```

**Response**:

```json
{
  "success": true,
  "userId": "uuid"
}
```

**Errors**:

```json
{
  "success": false,
  "error": "CPF inválido (deve ter 11 dígitos)" | "Email já cadastrado"
}
```

**Backend Logic**:

```javascript
const status = req.body.isAdmin === true ? 'admin' : 'active';
await createUser({ nome, cpf, email, password, status });
```

### Frontend Contracts

**Form Fields** (`auth/admin.html`):

```html
<input id="cpf" type="text" placeholder="Somente números" pattern="^\d{11}$" />
<label>
  <input id="isAdmin" type="checkbox" />
  Usuário Admin (acesso total)
</label>
```

**Validation** (`scripts/admin.js`):

```javascript
function validateCPF(cpf) {
  const clean = cpf.replace(/[^\d]/g, '');
  return /^\d{11}$/.test(clean) ? clean : null;
}
```

**Watermark Adapter** (`scripts/watermark.js`):

```javascript
const THEME_COLORS = {
  light: 'rgba(0, 0, 0, 0.08)',
  dark: 'rgba(255, 255, 255, 0.12)',
  sepia: 'rgba(80, 60, 40, 0.10)'
};

function getTheme() {
  return document.documentElement.dataset.theme || 'light';
}
```

---

## Phase 2: Task Planning

### Task Breakdown

**Admin Role** (5 tasks):

1. **T001**: Add checkbox em `auth/admin.html`
2. **T002**: CPF validation em `scripts/admin.js`
3. **T003**: Update form submission com `isAdmin`
4. **T004**: Modify `api/users/index.js` aceitar `isAdmin`
5. **T005**: Test admin user flow (checkbox → DB → login → access)

**Watermark** (4 tasks):

6. **T006**: Create theme color map em `watermark.js`
7. **T007**: Implement `getTheme()` function
8. **T008**: Refactor `createWatermark()` dynamic color
9. **T009**: Add MutationObserver theme changes

**Testing** (3 tasks):

10. **T010**: Test watermark 3 themes × 5 livros
11. **T011**: Test admin end-to-end
12. **T012**: Test CPF validation edge cases

**Total**: 12 tasks (est. 4-6h implementation + 2h testing)

---

## Implementation Notes

### Admin Checkbox

- Position: abaixo password field, antes botão "Criar Usuário"
- Label: "Usuário Admin (acesso total)"
- Default: unchecked
- Confirmation dialog: "Criar usuário como ADMIN? Terá acesso total."

### CPF Validation

- Strip: `cpf.replace(/[^\d]/g, '')`
- Regex: `/^\d{11}$/`
- Error: abaixo campo, red text, auto-dismiss 5s
- Backend já valida (sem changes)

### Watermark Color

- Current: hard-coded `color: '#000'`, `opacity: '0.6'`
- New: combined RGBA (color + opacity)
- Apply: all 180 watermark cells
- MutationObserver: `{ attributes: true, attributeFilter: ['data-theme', 'class'] }`

### Theme Detection Fallback

```javascript
function getTheme() {
  const dataTheme = document.documentElement.dataset.theme;
  if (dataTheme) return dataTheme;
  
  if (document.documentElement.classList.contains('dark')) return 'dark';
  if (document.documentElement.classList.contains('sepia')) return 'sepia';
  
  return 'light';
}
```

### Testing Checklist

- [ ] Admin checkbox appears
- [ ] CPF validation blocks invalid
- [ ] CPF accepts formatted (123.456.789-01)
- [ ] Admin user: `status='admin'` DB
- [ ] Admin access `/auth/admin.html`
- [ ] Admin access all books
- [ ] Regular user: `status='active'`
- [ ] Watermark visible light (black 0.08)
- [ ] Watermark visible dark (white 0.12)
- [ ] Watermark visible sepia (brown 0.10)
- [ ] Watermark updates on theme toggle
- [ ] Transition smooth (≤500ms)
- [ ] Text readable com opacity
- [ ] No console errors
- [ ] Vercel deploy success

---

## Risks & Mitigation

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Opacity too high → unreadable | HIGH | LOW | Spec tested values. Visual test 3+ people. |
| Theme attribute missing | MEDIUM | LOW | Fallback CSS class. All readers verified. |
| MutationObserver performance | LOW | LOW | 1 element, 1 attribute. Negligible. |
| Checkbox accidentally checked | MEDIUM | MEDIUM | Confirmation dialog. |
| Regex fails edge case | LOW | LOW | Unit test formatted/invalid inputs. |

---

## Post-Implementation

### Documentation Updates

- `quickstart.md` com usage examples
- API reference com `isAdmin` parameter
- README.md features list (se aplicável)

### Future Enhancements (Out of Scope)

- Admin revocation UI (atualmente manual DB)
- Dígitos verificadores CPF validation
- Configurable watermark colors
- Watermark intensity slider
- Admin audit log
